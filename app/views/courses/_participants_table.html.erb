<div class="w-full overflow-hidden rounded-lg border border-gray-200 shadow-sm">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 table-fixed">

      <%# --- Table Header --- %>
      <thead class="bg-gray-50">
        <tr>
          <th
            scope="col"
            class="
              px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider
              <%= @course.grouped? ? 'w-[14.28%]' : 'w-1/3' %>
            "
          >
            <div class="flex items-center justify-start gap-2">
              <%= image_tag "alphabet.svg", class: "w-5 h-5 opacity-70" %>
              <%= @course.grouped? ? "Group Name" : "Student Name" %>
            </div>
          </th>

          <th
            scope="col"
            class="
              px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider
              <%= @course.grouped? ? 'w-1/3' : 'w-[14.28%]' %>
            "
          >
            <div class="flex items-center justify-start gap-2">
              <%= image_tag "person_grey.svg", class: "w-5 h-5 opacity-70" %>
              <%= @course.grouped? ? "Members" : "Student ID" %>
            </div>
          </th>

          <%# 3. Project Title %>
          <th
            scope="col"
            class="
              px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider
              w-1/5
            "
          >
            <div class="flex items-center justify-start gap-2">
              <%= image_tag "project.svg", class: "w-5 h-5 opacity-70" %>
              Project Title
            </div>
          </th>

          <%# 4. Status %>
          <th
            scope="col"
            class="
              px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider
              w-1/8
            "
          >
            <div class="flex items-center justify-center gap-2">
              <%= image_tag "status_grey.svg", class: "w-5 h-5 opacity-70" %>
              Status
            </div>
          </th>

          <%# 5. Supervisor %>
          <th
            scope="col"
            class="
              px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider
              w-1/4
            "
          >
            <div class="flex items-center justify-start gap-2">
              <%= image_tag "person_grey.svg", class: "w-5 h-5 opacity-70" %>
              Supervisor
            </div>
          </th>
        </tr>
      </thead>

      <%# --- Table Body --- %>
      <tbody class="bg-white divide-y divide-gray-200">

        <% if @course.grouped? %>
          <% if group_list.present? %>
            <% group_list.each do |group| %>
              <% group_project = group_project_for(group, @course)
              current_instance = group_project&.project_instances&.order(:version)&.last
              status = group_status(group, @course)
              supervisor = current_instance&.supervisor %>
              <tr
                class="
                  hover:bg-gray-50 transition-colors duration-150 group divide-x divide-gray-200
                "
              >

                <%# 1. Group Name %>
                <td
                  class="
                    px-4 py-4 text-sm font-medium text-gray-900 align-top break-words text-center
                  "
                >
                  <%= link_to participant_profile_course_path(@course, group.id, 'group'), class: "hover:text-gray-700 hover:underline" do %>
                    <%= group.group_name || "Group #{group.id}" %>
                  <% end %>
                </td>

                <%# 2. Members List %>
                <td class="px-4 py-4 text-sm text-gray-500 align-top text-left">
                  <ul class="space-y-2">
                    <% group.project_group_members.includes(:user).each do |member| %>
                      <li class="block leading-snug">

                        <%= link_to participant_profile_course_path(@course, member.user.id, 'student'), class: "inline group/member hover:text-gray-900" do %>
                          <div
                            class="
                              inline-flex items-center justify-center w-5 h-5 rounded-full bg-gray-200
                              text-[10px] font-bold text-gray-600 align-middle mr-1
                              group-hover/member:bg-gray-300 transition-colors
                            "
                          >
                            <%= member.user.username.first.upcase %>
                          </div>
                          <span class="text-xs text-gray-700 align-middle group-hover/member:underline"><%= member.user.username || "-" %></span>
                        <% end %>

                        <%# Pending Badge (Inline, flows after name) %>
                        <% unless member.user.has_registered %>
                          <span
                            class="
                              inline-flex items-center align-middle gap-1 ml-1 whitespace-nowrap
                            "
                          >
                            <span
                              class="
                                bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded border
                                border-yellow-200 leading-none
                              "
                            >Pending</span>
                            <%= button_to resend_invite_path(member.user),
                                method: :post,
                                form: { class: "inline-flex items-center" },
                                class: "inline-flex items-center justify-center p-0 border-0 bg-transparent cursor-pointer text-gray-400 hover:text-gray-700 transition-colors",
                                title: "Resend Invite" do %>
                              <%= image_tag "email.svg", class: "w-4 h-4 opacity-80 hover:opacity-100 block" %>
                            <% end %>
                          </span>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </td>

                <%# 3. Project Title %>
                <td class="px-4 py-4 text-sm text-gray-700 align-top text-left">
                  <% if group_project.present? %>
                    <%= link_to course_project_path(@course, group_project), class: "font-medium text-gray-900 hover:text-gray-700 hover:underline line-clamp-2" do %>
                      <%= current_instance&.title || "-" %>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400 italic text-xs">-</span>
                  <% end %>
                </td>

                <%# 4. Status (Group) %>
                <td class="px-4 py-4 whitespace-nowrap align-top text-center">
                  <div class="flex flex-col items-center gap-1">
                    <%# --- STATUS BADGE --- %>
                    <% project_status = status.to_s.downcase %>
                    <% badge_classes, dot_class =
                      case project_status
                      when "approved"
                        ["bg-emerald-100 text-emerald-800 border-emerald-200", "bg-emerald-600"]
                      when "pending"
                        ["bg-blue-100 text-blue-800 border-blue-200", "bg-blue-600"]
                      when "redo"
                        ["bg-orange-100 text-orange-800 border-orange-200", "bg-orange-600"]
                      when "rejected"
                        ["bg-rose-100 text-rose-800 border-rose-200", "bg-rose-600"]
                      else
                        ["bg-gray-100 text-gray-600 border-gray-200", "bg-gray-500"]
                      end %>

                    <% link_target =
                      group_project.present? ? course_project_path(@course, group_project) : "#" %>

                    <a
                      href="<%= link_target %>"
                      class="
                        inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border
                        <%= badge_classes %> capitalize hover:opacity-80
                      "
                    >
                      <span class="w-1.5 h-1.5 rounded-full mr-1.5 <%= dot_class %>"></span>
                      <%= status.humanize %>
                    </a>

                    <%# --- PROGRESS INDICATOR (Below Badge) --- %>
                    <% if use_progress_updates && group_project.present? && project_status == "approved" %>
                      <% count = group_project.progress_updates.count %>
                      <span class="text-sm text-gray-600 font-normal flex items-center pt-1 gap-1">
                        <%= count %>
                        updates
                      </span>
                    <% end %>

                  </div>
                </td>

                <%# 5. Supervisor %>
                <td
                  class="
                    px-4 py-4 whitespace-nowrap text-sm text-gray-500 align-top text-left
                  "
                >
                  <% if supervisor.present? %>
                    <%= link_to course_lecturer_path(@course, supervisor), class: "flex items-center justify-start gap-2 group/sup" do %>
                      <div
                        class="
                          w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px]
                          font-bold text-gray-600 shrink-0 group-hover/sup:bg-blue-100
                          group-hover/sup:text-gray-700 transition-colors
                        "
                      >
                        <%= supervisor.username.first.upcase %>
                      </div>
                      <span
                        class="
                          truncate max-w-[150px] group-hover/sup:text-gray-700
                        "
                        title="<%= supervisor.username %>"
                      >
                        <%= supervisor.username %>
                      </span>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">-</span>
                  <% end %>
                </td>

              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500 italic">
                <%= if params[:status_filter].present? && params[:status_filter] != "all"
                  "No groups found with #{params[:status_filter].humanize} status."
                else
                  "No Groups have been added yet."
                end %>
              </td>
            </tr>
          <% end %>

        <% else %>
          <% if student_list.present? %>
            <% student_list.each do |student| %>
              <% student_project = student_project_for(student, @course)
              current_instance = student_project&.project_instances&.order(:version)&.last
              status = student_status(student, @course)
              supervisor = current_instance&.supervisor %>
              <tr
                class="
                  hover:bg-gray-50 transition-colors duration-150 group divide-x divide-gray-200
                "
              >

                <%# 1. Student Name %>
                <td class="px-4 py-4 text-sm font-medium text-gray-900 align-top text-left">
                  <div class="block leading-snug">
                    <%= link_to participant_profile_course_path(@course, student.id, 'student'), class: "inline group/member hover:text-gray-700" do %>
                      <div
                        class="
                          inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-200
                          text-[10px] font-bold text-gray-600 align-middle mr-1
                        "
                      >
                        <%= student.username.first.upcase %>
                      </div>
                      <span class="align-middle group-hover/member:underline"><%= student.username || "-" %></span>
                    <% end %>

                    <% unless student.has_registered %>
                      <span
                        class="
                          inline-flex items-center align-middle gap-1 ml-1 whitespace-nowrap
                        "
                      >
                        <span
                          class="
                            bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded border
                            border-yellow-200 leading-none
                          "
                        >Pending</span>
                        <%= button_to resend_invite_path(student),
                            method: :post,
                            form: { class: "inline-flex items-center" },
                            class: "inline-flex items-center justify-center p-0 border-0 bg-transparent cursor-pointer text-gray-400 hover:text-gray-700 transition-colors",
                            title: "Resend Invite" do %>
                          <%= image_tag "email.svg", class: "w-4 h-4 opacity-80 hover:opacity-100 block" %>
                        <% end %>
                      </span>
                    <% end %>
                  </div>
                </td>

                <%# 2. Student ID %>
                <td class="px-4 py-4 text-sm text-gray-500 align-top text-left">
                  <%= link_to participant_profile_course_path(@course, student.id, 'student'), class: "hover:text-gray-700" do %>
                    <%= student.student_id || "-" %>
                  <% end %>
                </td>

                <%# 3. Project Title %>
                <td class="px-4 py-4 text-sm text-gray-700 align-top text-left">
                  <% if student_project.present? %>
                    <%= link_to course_project_path(@course, student_project), class: "font-medium text-gray-900 hover:text-gray-700 hover:underline line-clamp-2" do %>
                      <%= current_instance&.title || "-" %>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400 italic text-xs">-</span>
                  <% end %>
                </td>

                <%# 4. Status (Student) %>
                <td class="px-4 py-3 whitespace-nowrap align-top text-center">
                  <div class="flex flex-col items-center gap-1">
                    <%# --- STATUS BADGE --- %>

                    <% project_status = status.to_s.downcase %>
                    <% badge_classes, dot_class =
                      case project_status
                      when "approved"
                        ["bg-emerald-100 text-emerald-800 border-emerald-200", "bg-emerald-600"]
                      when "pending"
                        ["bg-blue-100 text-blue-800 border-blue-200", "bg-blue-600"]
                      when "redo"
                        ["bg-orange-100 text-orange-800 border-orange-200", "bg-orange-600"]
                      when "rejected"
                        ["bg-rose-100 text-rose-800 border-rose-200", "bg-rose-600"]
                      else
                        ["bg-gray-100 text-gray-600 border-gray-200", "bg-gray-500"]
                      end %>

                    <% link_target =
                      student_project.present? ? course_project_path(@course, student_project) : "#" %>

                    <a
                      href="<%= link_target %>"
                      class="
                        inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border
                        <%= badge_classes %> capitalize hover:opacity-80
                      "
                    >
                      <span class="w-1.5 h-1.5 rounded-full mr-1.5 <%= dot_class %>"></span>
                      <%= status.humanize %>
                    </a>

                    <%# --- PROGRESS INDICATOR (Below Badge) --- %>
                    <% if use_progress_updates && student_project.present? && project_status == "approved" %>
                      <% count = student_project.progress_updates.count %>
                      <span class="text-sm text-gray-400 font-medium flex items-center gap-1">
                        <%= count %>
                        updates
                      </span>
                    <% end %>

                  </div>
                </td>
                <%# 5. Supervisor %>
                <td
                  class="
                    px-4 py-4 whitespace-nowrap text-sm text-gray-500 align-top text-left
                  "
                >
                  <% if supervisor.present? %>
                    <%= link_to course_lecturer_path(@course, supervisor), class: "flex items-center justify-start gap-2 group/sup" do %>
                      <div
                        class="
                          w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px]
                          font-bold text-gray-600 shrink-0 group-hover/sup:bg-blue-100
                          group-hover/sup:text-gray-700 transition-colors
                        "
                      >
                        <%= supervisor.username.first.upcase %>
                      </div>
                      <span
                        class="
                          truncate max-w-[150px] group-hover/sup:text-gray-700
                        "
                        title="<%= supervisor.username %>"
                      >
                        <%= supervisor.username %>
                      </span>
                    <% end %>
                  <% else %>
                    <span class="text-gray-400">-</span>
                  <% end %>
                </td>

              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500 italic">
                <%= if params[:status_filter].present? && params[:status_filter] != "all"
                  "No students found with #{params[:status_filter].humanize} status."
                else
                  "No students have been enrolled yet."
                end %>
              </td>
            </tr>
          <% end %>
        <% end %>

      </tbody>
    </table>
  </div>
</div>
