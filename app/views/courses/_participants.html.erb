<%# --- locals: course, use_progress_updates %>

<section class="mb-8 scroll-mt-24" id="participants" data-turbo="false">
  <div
    class="
      w-full bg-[#f8f9fa] rounded-[10px] p-5 shadow-sm border border-gray-100
    ">

    <%# --- Header & Filter Controls --- %>
    <header
      class="
        mb-5 flex flex-col md:flex-row md:items-center justify-between gap-4
      ">
      <h4 class="text-xl text-black font-normal m-0">Participants</h4>

      <% if participants_exceed?(@course) && !local_assigns[:fullpage] %>
        <%= link_to "Show all participants",
        course_participants_path(@course),
        class:
          "text-blue-600 hover:text-blue-800 text-sm font-medium hover:underline transition-colors" %>
      <% else %>
        <div
          class="
            flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 w-full md:w-auto
          ">
          <label
            for="status-filter"
            class="
              text-xs uppercase font-bold text-gray-500 tracking-wider whitespace-nowrap
            ">
            Filter by Status:
          </label>

          <div class="relative flex items-center justify-center gap-3 w-full sm:w-auto">
            <div class="relative flex items-center justify-center w-full sm:w-[200px]">
              <select
                id="status-filter"
                name="status_filter"
                class="
                  bg-white border border-gray-300 text-gray-700 text-sm rounded-lg
                  focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 pr-8 shadow-sm
                  transition-colors cursor-pointer appearance-none justify-center items-center
                "
                hx-get="<%= course_url(@course) %>"
                hx-target="#participants-table-container"
                hx-trigger="change"
                hx-include="this"
                hx-indicator="#loading-spinner">
                <option
                  value="all"
                  class="text-md"
                  <%= 'selected' if params[:status_filter] == 'all' || params[:status_filter].blank? %>>All Statuses</option>
                <option
                  value="approved"
                  class="text-md"
                  <%= 'selected' if params[:status_filter] == 'approved' %>>Approved</option>
                <option
                  value="pending"
                  class="text-md"
                  <%= 'selected' if params[:status_filter] == 'pending' %>>Pending</option>
                <option value="redo" <%= 'selected' if params[:status_filter] == 'redo' %>>Redo</option>
                <option
                  value="rejected"
                  class="text-md"
                  <%= 'selected' if params[:status_filter] == 'rejected' %>>Rejected</option>
                <option
                  value="not_submitted"
                  class="text-md"
                  <%= 'selected' if params[:status_filter] == 'not_submitted' %>>Not Submitted</option>
              </select>

              <div
                class="
                  pointer-events-none inset-y-0 right-0 flex justify-start items-center px-2
                  text-gray-500 -ml-[2em] -mt-[0.5em]
                ">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"></path></svg>
              </div>
            </div>

            <%# Loading Indicator %>
            <div
              id="loading-spinner"
              class="
                htmx-indicator flex items-center text-blue-600 text-sm font-medium
                whitespace-nowrap
              ">
              <svg
                class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Loading...
            </div>
          </div>
        </div>
      <% end %>
    </header>

    <%# Table Content %>

    <% use_progress_updates = local_assigns[:use_progress_updates] %>
    <% unless participants_exceed?(@course) && !local_assigns[:fullpage] %>
      <div id="participants-table-container" class="overflow-x-auto">
        <%= render "courses/participants_table",
        course: @course,
        group_list: @filtered_group_list,
        student_list: @filtered_student_list,
        students_with_projects: @students_with_projects,
        students_without_projects: @students_without_projects,
        use_progress_updates: use_progress_updates %>
      </div>

      <div
        class="
          mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-4 text-sm text-gray-500
          font-medium
        ">
        <% if @course.grouped? %>
          <div class="flex flex-col gap-2">
            <div class="flex items-center gap-1">
              <span class="text-gray-700 text-md font-semibold">Total Groups:</span>
              <%= @filtered_group_list&.count || 0 %>
            </div>

            <div class="flex items-center gap-1">
              <span class="text-gray-700 text-md font-semibold">Total Students:</span>
              <%= @filtered_student_list&.count || 0 %>
            </div>
          </div>
        <% else %>
          <div class="flex items-center gap-1">
            <span class="text-gray-700 text-md font-semibold">Total Students:
            </span>
            <%= @filtered_student_list&.count || 0 %>
          </div>
        <% end %>
      </div>
    <% end %>

  </div>
</section>
