<header
  class="w-full bg-gray-50 rounded-xl flex flex-col items-center gap-6 px-8">
  <h1
    class="
      text-3xl md:text-4xl font-bold text-gray-900 mb-6 mt-4 w-full break-words
      text-center md:text-left
    ">
    <%= current_instance.title %>
  </h1>

  <div class="w-full flex flex-col md:flex-row justify-between gap-8 lg:gap-12">

    <div class="flex flex-col gap-6">

      <div class="flex flex-row items-start gap-3">
        <span
          class="
            text-gray-700 font-semibold text-base flex items-center gap-2 min-w-[140px]
            shrink-0
          ">
          <%= image_tag("person.svg", class: "w-4 h-4 object-contain opacity-70") %>
          Type
        </span>
        <span class="text-gray-900">
          <p>Project</p>
        </span>
      </div>

      <div class="flex flex-row items-start gap-3">
        <span
          class="
            text-gray-700 font-semibold text-base flex items-center gap-2 min-w-[140px]
            shrink-0
          ">
          <%= image_tag("person.svg", class: "w-4 h-4 object-contain opacity-70") %>
          Owner
        </span>
        <div class="flex flex-col gap-2 items-start">
          <% if owner.is_a?(User) %>
            <p class="flex items-center gap-2">
              <span
                class="
                  inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-400
                  text-white text-xs font-bold uppercase
                ">
                <%= owner.username[0].upcase %>
              </span>
              <%= owner.username %>
            </p>
          <% else %>
            <% project.owner.users.each do |user| %>
              <p class="flex items-center gap-2">
                <span
                  class="
                    inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-400
                    text-white text-xs font-bold uppercase
                  ">
                  <%= user.username[0].upcase %>
                </span>
                <%= user.username %>
              </p>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="flex flex-row items-start gap-3">
        <span
          class="
            text-gray-700 font-semibold text-base flex items-center gap-2 min-w-[140px]
            shrink-0
          ">
          <%= image_tag("person.svg", class: "w-4 h-4 object-contain opacity-70") %>
          Supervisor
        </span>
        <span class="text-gray-900">
          <%= @current_instance.supervisor.username %>
        </span>
      </div>

      <% if project.owner.is_a?(ProjectGroup) %>
        <div class="flex flex-row items-start gap-3">
          <span
            class="
              text-gray-700 font-semibold text-base flex items-center gap-2 min-w-[140px]
              shrink-0
            ">
            <%= image_tag("group.svg", class: "w-4 h-4 object-contain opacity-70") %>
            Group Name
          </span>
          <span class="text-gray-900">
            <%= project.owner.group_name %>
          </span>
        </div>
      <% end %>
    </div>

    <div class="flex flex-col gap-6 min-w-[280px]">

      <div
        class="
          bg-white/80 backdrop-blur-sm rounded-xl p-3 flex flex-col gap-3 shadow-sm border
          border-white/50
        ">
        <div class="flex flex-row items-center justify-between gap-3">
          <span
            class="
              text-gray-700 font-semibold text-base flex items-center gap-2 shrink-0
            ">
            <%= image_tag("status.svg", class: "w-4 h-4 object-contain opacity-70") %>
            Status
          </span>

          <div class="flex-1 flex justify-end">
            <% if current_user == @project.supervisor && current_version == latest_version %>
              <div class="flex items-center gap-2">
                <%= form_with url: change_status_course_project_path(@course, @project), method: :patch, local: true, class: "flex items-center gap-2" do |f| %>
                  <% statuses = Project.statuses.keys.without("not_submitted") %>
                  <% status_color_class =
                    case current_instance.status
                    when "approved"
                      "bg-emerald-100 text-emerald-800 border-emerald-200"
                    when "rejected"
                      "bg-red-100 text-red-800 border-red-200"
                    when "redo"
                      "bg-orange-100 text-orange-800 border-orange-200"
                    else
                      "bg-gray-100 text-gray-800 border-gray-200"
                    end %>
                  <%= f.select :status,
                           options_for_select(
                             statuses.map { |s| [s.humanize, s] },
                             current_instance.status,
                           ),
                           {},
                           class:
                             "px-2 py-1 text-sm border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none #{status_color_class}" %>
                  <%= f.button type: "submit", class: "cursor-pointer hover:scale-110 transition-transform p-1", title: "Save status" do %>
                    <%= image_tag("check.svg", class: "w-4 h-4") %>
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <% badge_color =
                case current_instance.status
                when "approved"
                  "bg-emerald-600"
                when "rejected"
                  "bg-red-600"
                when "redo"
                  "bg-orange-500"
                else
                  "bg-gray-500"
                end %>
              <span
                class="
                  px-3 py-1 rounded-md text-white text-sm font-medium capitalize
                  <%= badge_color %>
                ">
                <%= current_instance.status.humanize %>
              </span>
            <% end %>
          </div>
        </div>

        <div
          class="
            text-xs text-gray-500 font-medium flex flex-col gap-1 border-t
            border-gray-200/50 pt-2 mt-1
          ">
          <% if @current_instance.last_status_change_time.present? %>
            <div class="opacity-90"><%= format_timestamp(@current_instance.last_status_change_time) || "-" %></div>
          <% end %>
          <div class="flex items-center gap-2">
            <% if @current_instance.last_status_change_by.present? %>
              <% dot_color =
                case @current_instance.status
                when "approved"
                  "bg-emerald-600"
                when "rejected"
                  "bg-red-600"
                when "redo"
                  "bg-orange-500"
                else
                  "bg-gray-400"
                end %>
              <span class="w-2.5 h-2.5 rounded-full <%= dot_color %> shrink-0"></span>
              <%= username(@current_instance.last_status_change_by) || "Not changed" %>
            <% else %>
              <div class="flex items-center gap-1">
                <%= image_tag("pending.svg", class: "w-4 h-4 opacity-50") %>
                Awaiting review
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div
        class="
          bg-white/80 backdrop-blur-sm rounded-xl p-3 flex flex-col gap-3 shadow-sm border
          border-white/50
        ">
        <div class="flex flex-row items-center justify-between gap-3">
          <span
            class="
              text-gray-700 font-semibold text-base flex items-center gap-2 shrink-0
            ">
            <%= image_tag("version.svg", class: "w-4 h-4 object-contain opacity-70") %>
            Version
            <% if current_version != latest_version %>
              <em class="text-xs text-gray-400 font-normal not-italic">(older)</em>
            <% end %>
          </span>

          <div class="flex items-center gap-3">
            <%# Back arrow %>
            <% if current_version > 1 %>
              <%= link_to course_project_path(@course, project, version: current_version - 1), class: "hover:bg-gray-100 rounded-full p-1 transition-colors" do %>
                <%= image_tag("arrow_back.svg", class: "w-3 h-3") %>
              <% end %>
            <% else %>
              <span class="opacity-30 p-1 cursor-not-allowed">
                <%= image_tag("arrow_back.svg", class: "w-3 h-3") %>
              </span>
            <% end %>

            <span class="text-sm font-bold text-gray-800 whitespace-nowrap"><%= current_version %>
              of
              <%= instances.size %></span>

            <%# Next arrow %>
            <% if current_version < instances.size %>
              <%= link_to course_project_path(@course, project, version: current_version + 1), class: "hover:bg-gray-100 rounded-full p-1 transition-colors" do %>
                <%= image_tag("arrow_forward.svg", class: "w-3 h-3") %>
              <% end %>
            <% else %>
              <span class="opacity-30 p-1 cursor-not-allowed">
                <%= image_tag("arrow_forward.svg", class: "w-3 h-3") %>
              </span>
            <% end %>
          </div>
        </div>

        <div
          class="
            text-xs text-gray-500 font-medium flex flex-col gap-1 border-t
            border-gray-200/50 pt-2 mt-1
          ">
          <% if @current_instance.last_edit_time.present? %>
            <div class="opacity-90"><%= format_timestamp(@current_instance.last_edit_time) || "-" %></div>
          <% end %>

          <div class="flex items-center gap-2">
            <% editor_id = @current_instance.last_edit_by || @current_instance.created_by_id %>
            <%= image_tag("edit.svg", class: "w-4 h-4 opacity-50") %>
            <%= username(editor_id) || "Not changed" %>
          </div>
        </div>
      </div>

    </div>
  </div>
</header>
