<section
  id="project-comments"
  class="
    w-full flex flex-col h-full bg-white rounded-2xl shadow-sm border
    border-gray-100 overflow-hidden
  "
>

  <div
    class="
      px-5 py-4 border-b border-gray-100 bg-gray-50/50 flex items-center
      justify-between
    "
  >
    <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Discussion</h2>
    <% if comments.any? %>
      <span
        class="
          px-2 py-0.5 rounded-full bg-gray-200 text-gray-600 text-xs font-bold
        "
      ><%= comments.count %></span>
    <% end %>
  </div>

  <div class="flex-1 overflow-y-auto bg-gray-50/30 p-5 custom-scrollbar relative">

    <% if comments.any? %>
      <div class="space-y-6 relative pl-4">

        <% comments.each do |comment| %>
          <article class="relative flex gap-4 z-10 group">

            <div class="flex-shrink-0 relative">
              <div
                class="
                  w-6 h-6 rounded-full bg-gray-400 text-white flex items-center justify-center
                  text-xs font-bold ring-4 ring-gray-50/30
                "
              >
                <%= comment.user.username[0].upcase %>
              </div>
            </div>

            <div class="flex-1 min-w-0">
              <header class="flex items-center gap-2 mb-1">
                <% if Current.user == comment.user %>
                  <h4 class="text-sm font-bold text-green-600"><%= comment.user.username %></h4>
                <% else %>
                  <h4 class="text-sm font-bold text-gray-800"><%= comment.user.username %></h4>
                <% end %>

                <span class="text-xs text-gray-400">
                  <% if comment.created_at > 3.days.ago %>
                    <%= time_ago_in_words(comment.created_at) %>
                    ago
                  <% else %>
                    <%= comment.created_at.strftime("%d %b, %I:%M %p") %>
                  <% end %>
                </span>

                <% if Current.user == comment.user && !comment.deleted %>
                  <%= link_to soft_delete_comment_path(comment),
                      data: { turbo_method: :patch, confirm: "Delete this comment?" },
                      class: "ml-auto text-gray-300 hover:text-red-500 transition-colors p-1 opacity-0 group-hover:opacity-100",
                      title: "Delete comment" do %>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"
                      /></svg>
                  <% end %>
                <% end %>
              </header>

              <div class="text-sm text-gray-600 leading-relaxed break-words">
                <% if !comment.deleted %>
                  <%= simple_format(comment.text, class: "mb-0") %>
                <% else %>
                  <span class="text-gray-400 italic text-xs bg-gray-100 px-2 py-0.5 rounded">This comment was deleted</span>
                <% end %>
              </div>
            </div>
          </article>
        <% end %>
      </div>

    <% else %>
      <div
        class="
          h-full flex flex-col items-center justify-center text-center opacity-60
        "
      >
        <svg
          class="w-12 h-12 text-gray-300 mb-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        ><path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
          /></svg>
        <p class="text-sm text-gray-500">No comments yet.</p>
        <p class="text-xs text-gray-400">Be the first to start the discussion.</p>
      </div>
    <% end %>
  </div>

  <% if (current_version == latest_version) && ((@members.map(&:id).include?(@current_user.id)) || @current_user == @current_instance.supervisor || @is_coordinator) %>
    <div class="p-4 border-t border-gray-100 bg-white">
      <%= form_with model: new_comment, local: true, class: "relative" do |form| %>
        <%= form.hidden_field :source_type, value: "ProjectInstance" %>
        <%= form.hidden_field :source_id, value: current_instance_id %>

        <div
          class="
            flex items-end gap-2 bg-gray-50 rounded-xl p-2 border border-gray-200
            focus-within:border-blue-400 focus-within:ring-2 focus-within:ring-blue-100
            transition-all
          "
        >
          <%= form.text_area :user_comment,
                         class:
                           "w-full bg-transparent border-0 focus:ring-0 text-sm text-gray-800 placeholder-gray-400 resize-none py-2 px-2 max-h-32 min-h-[40px]",
                         rows: 1,
                         placeholder: "Write a comment..." %>

          <%= form.button type: "submit", class: "p-2 bg-white text-blue-600 rounded-lg shadow-sm border border-gray-100 hover:bg-blue-50 hover:text-blue-700 transition-colors flex-shrink-0", title: "Send" do %>
            <svg
              class="w-4 h-4 transform rotate-90"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              /></svg>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

</section>
