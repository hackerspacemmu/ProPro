<!DOCTYPE html>
<html lang="en">
  <head>
    <%= stylesheet_link_tag "projects" %>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Proposal</title>
  </head>
  <body>
    <main class="project-edit">
      <header class="edit-header">
        <div class="edit-header-row">
          <h1 class="edit-title">Create Proposal for <%= @course.course_name %> <%= image_tag("edit.svg") %></h1>
        </div>
        <p class="edit-description">Fill out your proposal details and information below.</p>
      </header>

      <%= form_with url: course_projects_path(@course), method: :post, class: "edit-form" do |form| %>
        <div class="fields-container">
          <% @template_fields.each do |field| %>
            <div class="field-row">
              <%= label_tag "fields_#{field.id}", field.label, class: "field-label", title: field.hint %>
              <% if field.hint.present? %>
                <p class="field-hint"><%= field.hint %></p>
              <% end %>

              <% case field.field_type %>
              <% when "shorttext" %>
                <%= text_field_tag "fields[#{field.id}]", nil, class: "form-control", placeholder: field.hint, required: true %>

              <% when "textarea" %>
                <%= text_area_tag "fields[#{field.id}]", nil, class: "form-control", placeholder: field.hint, required: true %>

              <% when "dropdown" %>
                <% options = field.option_list %>
                <%= select_tag "fields[#{field.id}]", options_for_select(options), prompt: "Select an option", class: "form-control", required: true %>

              <% when "radio" %>
                <div class="radio-group">
                <% options = field.option_list %>
                <% options.each_with_index do |option, idx| %>
                  <div class="radio-option">
                    <%= radio_button_tag "fields[#{field.id}]", option, false, id: "field_#{field.id}_#{idx}", required: true %>
                    <%= label_tag "field_#{field.id}_#{idx}", option %>
                  </div>
              <% end %>
              </div>
              <% else %>          
                <%= text_field_tag "fields[#{field.id}]", nil, class: "form-control", required: true %>
              <% end %>
            </div>
          <% end %>
        </div>

        <div class="field">
          <label>Based on Topic</label><br />
          <select name="based_on_topic" class="form-control" required>
            <% if @selected_topic_id.nil? %>
              <option value="" selected disabled>-- Select a Topic --</option>
            <% end %>
            <% @lecturer_options.each do |lecturer_enrolment| %>
              <% lecturer = lecturer_enrolment.user %>
              <optgroup label="<%= lecturer.username %>">
                <% approved_topics = Topic.where(status: :approved, course: @course, owner_type: "User", owner_id: lecturer.id) %>

                <% approved_topics.each do |topic| %>
                  <% latest_instance = topic.topic_instances
                                        .order(version: :desc)
                                        .first %>
                  <option value="<%= topic.id %>" <%= 'selected' if topic.id == @selected_topic_id %>>
                    <%= "#{lecturer.username} - #{latest_instance&.title || 'Untitled Topic'}" %>
                  </option>
                <% end %>

                <option value="own_proposal_<%= lecturer.id %>">
                  <%= "#{lecturer.username} - Own Proposal" %>
                </option>
              </optgroup>
            <% end %>
          </select>
        </div>
        <div>
          <%= link_to "â† Back to Proposal", course_path(@course) %>
          <%= submit_tag "Create Proposal", class: "btn btn-primary" %>
        </div>
      <% end %>
    </main>
  </body>
</html>
