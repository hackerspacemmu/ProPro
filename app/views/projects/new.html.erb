<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "tailwind", "new_tailwind" %>
<% end %>
<% breadcrumb :new_project, @course %>
<% content_for :title,
"Create Proposal - #{@course.course_name.truncate(TITLE_NAME_LIMIT)} | ProPro" %>

<main class="min-h-screen bg-gray-50 w-full pt-[120px] pb-12 px-4 md:px-8">
  <div class="mx-auto w-full lg:w-10/12 2xl:w-8/12">

    <div class="mb-8">
      <%= link_to course_path(@course), class: "group inline-flex items-center text-sm font-medium text-gray-500 hover:text-green-600 transition-colors mb-4" do %>
        <div
          class="
            w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center
            justify-center mr-2 group-hover:border-green-300 shadow-sm transition-all
          "
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            /></svg>
        </div>
        Back to Course
      <% end %>

      <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
        Create Proposal for
        <%= @course.course_name %>
        <%= image_tag("edit.svg", class: "w-6 h-6 opacity-60") %>
      </h1>
      <p class="text-gray-500 mt-2 text-sm">
        Fill out the details below to submit your project proposal.
      </p>
    </div>

    <div
      class="
        bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden
      "
    >
      <div class="p-6 md:p-8">
        <%= form_with url: course_projects_path(@course), method: :post, class: "space-y-8" do |form| %>

          <%# resuable input class %>
          <% input_classes =
            "w-full px-4 py-3 border border-gray-200 rounded-xl text-gray-700 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium placeholder-gray-400" %>

          <div class="space-y-6">
            <% @template_fields.each do |field| %>
              <div class="flex flex-col">

                <%= label_tag "fields_#{field.id}",
                field.label,
                class: "block text-sm font-bold text-gray-700 uppercase tracking-wide mb-2",
                title: field.hint %>

                <% if field.hint.present? %>
                  <p class="text-xs text-gray-400 mb-2 leading-normal whitespace-pre-line"><%= field.hint %></p>
                <% end %>

                <% case field.field_type %>
                <% when "shorttext" %>
                  <%= text_field_tag "fields[#{field.id}]",
                  nil,
                  class: input_classes,
                  placeholder: "Enter #{field.label.downcase}...",
                  required: true %>

                <% when "textarea" %>
                  <%= text_area_tag "fields[#{field.id}]",
                  nil,
                  class: "#{input_classes} min-h-[120px] resize-y leading-relaxed",
                  placeholder: "Enter details...",
                  required: true %>

                <% when "dropdown" %>
                  <div class="relative">
                    <% options = field.option_list %>
                    <%= select_tag "fields[#{field.id}]",
                    options_for_select(options),
                    prompt: "Select an option",
                    class: "#{input_classes} appearance-none pr-10",
                    required: true %>
                    <div
                      class="
                        absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none
                      "
                    >
                      <svg
                        class="w-4 h-4 text-gray-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      ><path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        /></svg>
                    </div>
                  </div>

                <% when "radio" %>
                  <div class="mt-2 space-y-3">
                    <% options = field.option_list %>
                    <% options.each_with_index do |option, idx| %>
                      <div class="flex items-center">
                        <%= radio_button_tag "fields[#{field.id}]",
                        option,
                        false,
                        id: "field_#{field.id}_#{idx}",
                        required: true,
                        class: "w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500" %>
                        <%= label_tag "field_#{field.id}_#{idx}",
                        option,
                        class: "ml-3 block text-sm font-medium text-gray-700 cursor-pointer" %>
                      </div>
                    <% end %>
                  </div>

                <% else %>
                  <%= text_field_tag "fields[#{field.id}]", nil, class: input_classes, required: true %>
                <% end %>
              </div>
            <% end %>
          </div>

          <hr class="border-gray-100 my-8">

          <div class="flex flex-col">
            <label
              class="
                block text-sm font-bold text-gray-700 uppercase tracking-wide mb-2
              "
            >Based on Topic</label>

            <div class="relative">
              <select
                name="based_on_topic"
                class="
                  <%= input_classes %> appearance-none pr-10
                "
                required
              >
                <% if @selected_topic_id.nil? %>
                  <option value="" selected disabled>-- Select a Topic --</option>
                <% end %>
                <% @lecturer_options.each do |lecturer_enrolment| %>
                  <% lecturer = lecturer_enrolment.user %>
                  <optgroup label="<%= lecturer.username %>">
                    <% approved_topics =
                      Topic.where(
                        status: :approved,
                        course: @course,
                        owner_type: "User",
                        owner_id: lecturer.id,
                      ) %>

                    <% approved_topics.each do |topic| %>
                      <% latest_instance = topic.topic_instances.order(version: :desc).first %>
                      <option
                        value="<%= topic.id %>"
                        <%= 'selected' if topic.id == @selected_topic_id %>
                      >
                        <%= "#{lecturer.username} - #{latest_instance&.title || "Untitled Topic"}" %>
                      </option>
                    <% end %>

                    <option value="own_proposal_<%= lecturer.id %>">
                      <%= "#{lecturer.username} - Own Proposal" %>
                    </option>
                  </optgroup>
                <% end %>
              </select>
              <div
                class="
                  absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none
                "
              >
                <svg
                  class="w-4 h-4 text-gray-500"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  /></svg>
              </div>
            </div>
          </div>

          <div class="pt-6 border-t border-gray-100 flex items-center justify-end gap-4">
            <%= link_to "Cancel",
            course_path(@course),
            class:
              "text-sm font-bold text-gray-500 hover:text-gray-700 px-4 py-2 transition-colors" %>

            <%= submit_tag "Create Proposal",
            class:
              "cursor-pointer bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-slate-500/20 transition-all transform active:scale-95 text-sm" %>
          </div>

        <% end %>
      </div>
    </div>

  </div>
</main>
