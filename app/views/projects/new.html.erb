<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "projects" %>
<% end %>
<% breadcrumb :new_project, @course %>
<% content_for :title, "Create Proposal - #{@course.course_name.truncate(TITLE_NAME_LIMIT)} | ProPro" %>


<main class="project-edit">
  <header class="edit-header">
    <div class="edit-header-row">
      <h1 class="edit-title">Create Proposal for <%= @course.course_name %> <%= image_tag("edit.svg") %></h1>
    </div>
    <p class="edit-description">Fill out your proposal details and information below.</p>
  </header>

  <%= form_with url: course_projects_path(@course), method: :post, class: "edit-form" do |form| %>
    <div class="fields-container">

    <div class="field">
      <label>Based on Topic</label><br />
      <select name="based_on_topic" class="form-control" required
				hx-get="<%= selected_topic_course_projects_path(@course) %>"
				hx-trigger="change"
				hx-target="#template-fields-container"
				hx-swap="outerHTML"
				hx-include="[name='based_on_topic']"
				>

        <% if @selected_topic_id.nil? %>
          <option value="" selected disabled>-- Select a Topic --</option>
        <% end %>
        <% @lecturer_options.each do |lecturer_enrolment| %>
          <% lecturer = lecturer_enrolment.user %>
          <optgroup label="<%= lecturer.username %>">
            <% approved_topics = Topic.where(status: :approved, course: @course, owner_type: "User", owner_id: lecturer.id) %>

            <% approved_topics.each do |topic| %>
              <% latest_instance = topic.topic_instances
                                    .order(version: :desc)
                                    .first %>
              <option value="<%= topic.id %>" <%= 'selected' if topic.id == @selected_topic_id %>>
                <%= "#{lecturer.username} - #{latest_instance&.title || 'Untitled Topic'}" %>
              </option>
            <% end %>

            <option value="own_proposal_<%= lecturer.id %>">
              <%= "#{lecturer.username} - Own Proposal" %>
            </option>
          </optgroup>
        <% end %>
      </select>
    </div>

		<div id="template-fields-container">
  		<%= render 'project_new', 
			template_fields: @template_fields,
			field_values: @field_values %>
		</div>

    <div>
      <%= link_to "â† Back to Proposal", course_path(@course) %>
      <%= submit_tag "Create Proposal", class: "btn btn-primary" %>
    </div>
  <% end %>
</main>
