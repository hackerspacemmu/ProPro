<div class="w-full space-y-8">
  <div
    class="
      bg-white rounded-xl divide-y divide-gray-100 border border-gray-100 shadow-sm
      overflow-hidden
    "
  >
    <% fields.each do |field| %>

      <div
        class="
          grid grid-cols-[140px_1fr] md:grid-cols-3 group hover:bg-gray-50/50
          transition-colors
        "
      >

        <%# Field Label %>
        <div
          class="
            p-4 md:p-6 md:col-span-1 bg-gray-50/30 border-r border-gray-100 flex
            items-center md:items-start
          "
        >
          <h4
            class="
              text-xs md:text-sm font-bold text-gray-700 uppercase tracking-wide
              leading-relaxed break-words
            "
          >
            <%= field.project_template_field.label %>
          </h4>
        </div>

        <%# this is for parsing before rendering (to minimize whitespace in project field value) %>
        <% display_text = nil
        
        if field.value.present?
          if field.project_template_field.dropdown? ||
               field.project_template_field.radio?
            begin
              parsed = JSON.parse(field.value)
              display_text = parsed.is_a?(Array) ? parsed.join(", ") : parsed
            rescue JSON::ParserError
              display_text = field.value
            end
          else
            display_text = field.value
          end
          display_text = display_text.to_s.strip
        end %>

        <div
          class="
            p-4 md:p-6 md:col-span-2 text-gray-900 break-words text-base md:text-lg
            font-medium whitespace-pre-wrap leading-relaxed
          "
        ><% if display_text.present? %><%= display_text %><% else %><span class="text-gray-400 italic font-normal text-sm">No content provided</span><% end %></div>
      </div>
    <% end %>

    <div
      class="
        bg-gray-50/80 p-4 text-xs text-gray-500 font-medium border-t border-gray-100
        flex items-center gap-2
      "
    >
      <svg
        class="w-4 h-4 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      ><path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        /></svg>
      Based on Topic:
      <span class="text-gray-700 font-semibold"><%= based_on_topic_name || "Own Proposal" %></span>
    </div>
  </div>

  <%# --- VERSION DIFF COMPARISON --- %>
  <% if @index < @instances.size %>
    <div class="mt-8">
      <div class="flex items-center gap-3 mb-4">
        <h4 class="text-lg font-bold text-gray-800">Version Changes</h4>
        <span
          class="
            px-2.5 py-0.5 rounded-full bg-orange-100 text-orange-700 text-xs font-bold
            border border-orange-200
          "
        >
          Comparing v<%= @index %>
          vs v<%= @index + 1 %>
        </span>
      </div>

      <div
        class="
          bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden
        "
      >
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr
                class="
                  bg-gray-50 border-b border-gray-200 text-xs uppercase tracking-wider
                  text-gray-500 font-semibold
                "
              >
                <th class="p-3 w-48 border-r border-gray-200">Field</th>
                <th class="p-3 w-1/2 border-r border-gray-200 bg-red-50/30 text-red-800">Deletions (Old)</th>
                <th class="p-3 w-1/2 bg-green-50/30 text-green-800">Additions (New)</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">

              <% fields.zip(next_fields).each do |current_field, next_field| %>
                <% field_name = (current_field || next_field).project_template_field.label %>

                <% normalize = ->(text) do
                  text.to_s.gsub(/\r\n?/, "\n").gsub(/^$/, "[[EMPTYLINE]]")
                end %>

                <% clean_display = ->(text) do
                  if text.to_s.strip == "[[EMPTYLINE]]"
                    "&nbsp;".html_safe
                  else
                    text.to_s.gsub("[[EMPTYLINE]]", "")
                  end
                end %>

                <% old_val = normalize.call(current_field&.value) %>
                <% new_val = normalize.call(next_field&.value) %>

                <% if old_val != new_val %>
                  <tr class="bg-white group hover:bg-gray-50/20 transition-colors">
                    <td
                      class="
                        p-3 text-sm font-bold text-gray-700 align-top border-r border-gray-200
                        bg-gray-50/30
                      "
                    >
                      <%= field_name %>
                    </td>

                    <td colspan="2" class="p-0 align-top">
                      <div class="w-full font-mono text-sm leading-tight">

                        <% old_lines = old_val.split("\n") %>
                        <% new_lines = new_val.split("\n") %>
                        <% diffs = Diff::LCS.sdiff(old_lines, new_lines) %>

                        <% diffs.each do |change| %>
                          <div
                            class="
                              grid grid-cols-2 border-b border-gray-100 last:border-0 min-h-[1.5em]
                            "
                          >

                            <% case change.action %>
                            <% when '=' %>
                              <div
                                class="
                                  px-3 py-1 border-r border-gray-100 text-gray-400 select-none bg-white
                                "
                              >
                                <%= clean_display.call(change.old_element) %>
                              </div>
                              <div class="px-3 py-1 text-gray-800 bg-white">
                                <%= clean_display.call(change.new_element) %>
                              </div>

                            <% when '-' %>
                              <div class="px-3 py-1 border-r border-red-200 bg-red-50 text-red-900 break-all">
                                <span class="bg-red-200 line-through decoration-red-400 decoration-2">
                                  <%= clean_display.call(change.old_element) %>
                                </span>
                              </div>
                              <div class="px-3 py-1 bg-gray-50/50"></div>

                            <% when '+' %>
                              <div class="px-3 py-1 border-r border-gray-100 bg-gray-50/50"></div>
                              <div class="px-3 py-1 bg-green-50 text-green-900 break-all">
                                <span class="bg-green-200 font-medium">
                                  <%= clean_display.call(change.new_element) %>
                                </span>
                              </div>

                            <% when '!' %>
                              <% old_words = change.old_element.split(/(\s+)/)
                              new_words = change.new_element.split(/(\s+)/)
                              word_diffs = Diff::LCS.sdiff(old_words, new_words)
                              is_empty_marker = ->(w) { w.to_s.strip == "[[EMPTYLINE]]" }
                              
                              left_html =
                                word_diffs
                                  .map do |w|
                                    text = is_empty_marker.call(w.old_element) ? "&nbsp;" : h(w.old_element)
                              
                                    if w.action == "-" || w.action == "!"
                                      "<span class='bg-red-200 text-red-900 line-through decoration-red-400 decoration-2'>#{text}</span>"
                                    else
                                      "<span class='text-gray-500 opacity-80'>#{text}</span>"
                                    end
                                  end
                                  .join
                              
                              right_html =
                                word_diffs
                                  .map do |w|
                                    text = is_empty_marker.call(w.new_element) ? "&nbsp;" : h(w.new_element)
                              
                                    if w.action == "+" || w.action == "!"
                                      "<span class='bg-green-200 text-green-900 font-medium'>#{text}</span>"
                                    else
                                      "<span class='text-gray-800'>#{text}</span>"
                                    end
                                  end
                                  .join %>

                              <div class="px-3 py-1 border-r border-red-200 bg-red-50 break-all">
                                <%= left_html.html_safe %>
                              </div>
                              <div class="px-3 py-1 bg-green-50 break-all">
                                <%= right_html.html_safe %>
                              </div>
                            <% end %>

                          </div>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>
