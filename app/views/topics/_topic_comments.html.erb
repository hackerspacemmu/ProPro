<section class="project-comments" id="topic-comments">
  <header class="section-header">
    <h2 class="section-title">Comments</h2>
  </header>
  <div class="comments-container">
    <% if comments&.any? %>
      <div class="comments-list">
        <% comments.each do |comment| %>
          <article class="comment">
            <div class="comment-marker">
              <span class="user-badge"><%= comment.user.username[0].upcase %></span>
            </div>
            <div class="comment-body-wrapper">
              <header class="comment-header">
                <% if Current.user == comment.user %>
                  <h4 class="comment-author" style="color: green"><%= comment.user.username %></h4>
                <% else %>
                  <h4 class="comment-author"><%= comment.user.username %></h4>
                <% end %>
                <time class="comment-date">
                  <% if comment.created_at > 3.days.ago %>
                    <%= time_ago_in_words(comment.created_at) %> ago
                  <% else %>
                    <%= format_timestamp(comment.created_at) %>
                  <% end %>
                </time>
                <% if policy(comment).destroy? %>
                    <div class="comment-actions">
                      <%= link_to soft_delete_comment_path(comment),
                        data: { turbo_method: :patch, confirm: "Are you sure you want to delete this comment?" },
                        class: "delete-comment-btn",
                        title: "Delete comment" do %>
                        <span class="delete-icon">Ã—</span>
                        <% end %>
                    </div>
                <% end %>
              </header>
              <div class="comment-body">
                <% if !comment.deleted %>
                  <%= simple_format(comment.text) %>
                <% else %>
                  <span class="deleted-comment">This comment was deleted</span>
                <% end %>
              </div>
            </div>
          </article>
        <% end %>
      </div>
    <% else %>
      <div class="no-comments">
        <p>There are no comments yet.</p>
      </div>
    <% end %>
    
    <% if policy(new_comment).create? %>
      <div class="comment-form-container">
        <%= form_with model: new_comment, local: true, class: "comment-form" do |form| %>
          <%= form.hidden_field :source_type, value: "TopicInstance" %>
          <%= form.hidden_field :source_id, value: current_instance_id %>
          
          <div class="form-group">
            <div class="comment-input-wrapper">
              <%= form.text_area :user_comment, class: "comment-textarea", rows: 4, placeholder: "add a comment..." %>
              <%= form.button class: "send-btn", type: "submit", title: "Send comment" do %>
                <%= image_tag "send.svg" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</section>